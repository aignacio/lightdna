var hero=angular.module("superhero",["ui.bootstrap","ngRoute","lightcontroller"]);hero.config(["$controllerProvider",function(e){e.allowGlobals()}]),hero.config(["$routeProvider",function(e){e.when("/dash",{templateUrl:"/pages/windows/dash.ejs",controller:""}).when("/about",{templateUrl:"/pages/windows/about.ejs",controller:""}).when("/time",{templateUrl:"/pages/windows/time.ejs",controller:""}).when("/power",{templateUrl:"/pages/windows/power.ejs",controller:""}).when("/list",{templateUrl:"/pages/windows/list.ejs",controller:""}).when("/control",{templateUrl:"/pages/windows/control.ejs",controller:""}).when("/users",{templateUrl:"/pages/windows/users.ejs",controller:""}).when("/pass",{templateUrl:"/pages/windows/pass.ejs",controller:""}).when("/csv",{templateUrl:"/pages/windows/csv.ejs",controller:""}).otherwise({redirectTo:"/dash",controller:"groupCtrl"})}]);
function pageInd(a){switch(a){case"1":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-laptop"></span> Principal</a>');break;case"2":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-list-ul"></span> Lista de Luminárias</a>');break;case"3":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-clock-o"></span> Relógio</a>');break;case"4":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-cog"></span> Configurações</a>');break;case"5":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-bolt"></span> Potência</a>');break;case"6":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-bolt"></span> Aparência</a>');break;case"7":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-user"></span> Usuários</a>');break;case"8":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-key"></i> Alterar a senha</a>');break;case"9":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-tachometer"></span> Controle</a>');break;case"14":$("#pageIndicator").html('<i class="fa fa-home fa-fw"></i> Home <i class="fa fa-chevron-right"></i> <span class="menu-icon fa fa-info"></span> Sobre</a>');break;default:console.log("Opção de menu desconhecida!!")}}$(document).ready(function(){$(".sidebar-brand").click(function(a){a.preventDefault(),$("#wrapper").toggleClass("toggled"),$("#wrapper").toggleClass("untoggled")}),pageInd("1"),console.log("ready!")});
var lightcontroller=angular.module("lightcontroller",["ngAnimate","smart-table","ngLocationUpdate","ui.bootstrap","ngCsvImport","ngCsv","ngSanitize","ui.knob","ui.bootstrap-slider","kk.timepicker","chart.js","ntt.TreeDnD","uiSwitch"]);lightcontroller.controller("loginCtrl",["$scope",function(t){}]),lightcontroller.controller("gmapsCtrl",["$scope","$timeout","$templateCache","$http","$uibModal","$compile","$routeParams","ShareZoomLight","SharelightTAGid",function(t,e,a,o,n,i,r,s,l){function u(e){$.each(e.markers,function(e,a){var o;o="1"==a.status?0===a.dimmer?new google.maps.Marker({position:a.position,map:m,title:a.title,text:a.group,icon:"../../img/icons/light_off.png"}):new google.maps.Marker({position:a.position,map:m,title:a.title,text:a.group,icon:"../../img/icons/light_ok.png"}):new google.maps.Marker({position:a.position,map:m,title:a.title,text:a.group,icon:"../../img/icons/light_warn.png"}),h.extend(o.position),o.addListener("click",function(){var e=i(a.content)(t);p.setContent(e[0]),t.$apply(),p.setOptions({position:a.position}),p.open(m,this)}),g.push(o)})}function d(t){var e,a;e="1"==t.status.status?'<span style="color:green;">OK</span>':'<span style="color:#D8A619;">Alerta</span>',a="0"==t.status.dimmer?"Desligada":t.status.dimmer+"%";var o='<div id="light"><b>Luminária - '+t.TAG+":</br></b><b>Corrente:</b>"+t.status.current+'mA</br><b>Dimmer:</b><a style="font-weight:bold;" type="button" ng-click="DimmerLight(\''+t.TAG+"','"+t.status.dimmer+"','"+t.LAT+"','"+t.LONG+"')\">"+a+"</a></br><b>RSSI:</b>"+t.status.rssi+"dBm</br><b>Status:"+e+"</b></br><b>Grupo</b>:"+t.group.grupo+"</b></br><div>";return o}var c={markers:[]},m=new google.maps.Map(document.getElementById("map_canvas"),{zoom:8,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP});t.lightZ=s,t.lightSel=l,tions={gridSize:50,maxZoom:15};var g=[],p=new google.maps.InfoWindow,h=new google.maps.LatLngBounds;o({method:"GET",url:"/lights/getLights"}).then(function(e){for(var a=0;a<e.data.length;a++)c.markers.push({position:{lat:Number(e.data[a].LAT),lng:Number(e.data[a].LONG)},title:"Luminária "+e.data[a].TAG,content:d(e.data[a]),group:e.data[a].group.grupo,status:e.data[a].status.status,dimmer:e.data[a].status.dimmer});if(u(c),t.lightZ.view===!0){t.lightZ.view=!1;var o=new google.maps.LatLng(Number(t.lightZ.lat),Number(t.lightZ["long"]));m.setCenter(o),m.setZoom(20)}else m.fitBounds(h);var n={gridSize:50,maxZoom:17};new MarkerClusterer(m,g,n)},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.DimmerLight=function(e,a,o,i){t.lightSel.tag=e,t.lightSel.dimmer=a,t.lightSel.lat=o,t.lightSel["long"]=i,t.mapInst=m;n.open({animation:!0,templateUrl:"modalLights.html",controller:"ModalInstanceCtrl"})}}]),lightcontroller.service("SharelightTAGid",function(){var t={tag:"",dimmer:"",lat:"","long":""};return t}),lightcontroller.service("ShareZoomLight",function(){var t={lat:"","long":"",view:!1};return t}),lightcontroller.controller("ModalInstanceCtrl",["$scope","$uibModalInstance","SharelightTAGid","$http",function(t,e,a,o){t.lightSel=a,t.mapInst=a,t.tag=t.lightSel.tag,"0"==t.lightSel.dimmer?t.dimmer="Desligada":t.dimmer=t.lightSel.dimmer,t.lightSlider={name:"teste",value:t.dimmer,max:"100",min:"0",step:"10",ticks:[20,30,40,50,60,70,80,90,100],labels:["Mínimo","30%","40%","50%","60%","70%","80%","90%","Máximo"]},t.off=function(){e.close(),o({url:"/lights/setLights",method:"POST",data:{light:t.tag,dimmer:"0"},headers:{"Content-Type":"application/json"}}).then(function(e){"ok"==e.data.status?alert("Luminária "+t.tag+" desligada!"):alert("Não foi possível alterar o valor de dimmer!")},function(e){t.data=e.data||"Request failed",t.status=e.status})},t.DimmerLight=function(){e.close(),o({url:"/lights/setLights",method:"POST",data:{light:t.tag,dimmer:t.lightSlider.value},headers:{"Content-Type":"application/json"}}).then(function(e){"ok"==e.data.status?alert("Luminária "+t.tag+" atualizada!\n\r"+t.lightSel.lat+"\n\r"+t.lightSel["long"]):alert("Não foi possível alterar o valor de dimmer!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.cancel=function(){e.dismiss()}}]),lightcontroller.controller("groupCtrl",["$scope","$uibModal","ShareOfflineGroup","$parse","$timeout","$http","$templateCache",function(t,e,a,o,n,i,r){function s(){t.enabled?t.switchDimmer&&(t.switchDimmer=0,t.groupSelected.dimmer?t.dimmer=t.groupSelected.dimmer:t.dimmer=20):t.dimmer=0,t.enabled&&t.dimmer<20&&!t.wasZero&&(t.dimmer=0,t.enabled=0),0===t.groupSelected.dimmer&&t.dimmer<20&&t.enabled&&(t.dimmer=0,t.enabled=0),i({method:"GET",url:"/groups/getGroups"}).then(function(e){t.groups=e.data,t.rowCollection=e.data;for(var a=0;a<t.groups.length;a++)t.group==t.groups[a].name&&(t.groupSelected=t.groups[a],l())},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})}function l(){t.uptoDate&&t.groupChange&&(t.uptoDate=0,t.groupChange=0,t.dimmer=t.groupSelected.dimmer,0===t.dimmer?t.wasZero=1:t.wasZero=0,t.dimmer>=20?t.enabled=!0:(t.dimmer=0,t.enabled=!1))}t.groups={},t.dimmer=0,t.intervalFunction=function(){time=n(function(){s(),t.intervalFunction()},1e3)},t.intervalFunction(),t.$on("$routeChangeStart",function(t,e,a){n.cancel(time)}),t.$watch("enabled",function(){t.switchDimmer=1}),t.$watch("group",function(){t.groupChange=1,t.uptoDate=1}),t.options={size:250,unit:"%",startAngle:-120,endAngle:120,step:10,displayPrevious:!0,trackWidth:40,barWidth:30,trackColor:"rgba(0,0,0,.1)",barColor:"#494B52",prevBarColor:"gray",scale:{enabled:!0,type:"dots",width:1,quantity:11},textColor:"#494B52",subText:{enabled:!0,text:"Dimmer",color:"gray"}},t.setDimmerGroup=function(){console.log("Grupo:"+t.group+"\nDimmer:"+t.dimmer);var e={group:t.group,dimmer:t.dimmer};i({url:"/groups/setDimmer",method:"POST",data:e,headers:{"Content-Type":"application/json"}}).then(function(t){"ok"==t.data.status?alert("Valor setado de dimmer para o grupo!"):alert("Não foi possível setar este valor de dimmer!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.itemsByPage=5,t.displayedCollection=[],t.rowCollection=[],t.displayedCollection=[].concat(t.rowCollection);var u={values:[]};i({method:"GET",url:"/groups/getGroups"}).then(function(e){t.group=e.data[0].name,t.rowCollection=e.data,t.groupSelected=e.data[0],l();for(var a=0;a<e.data.length;a++)u.values.push(e.data[a].name);0===t.dimmer&&(t.wasZero=1),t.groupopt=u},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.groupName=a,t.offlineLights=function(){t.groupName.name=t.groupSelected.name;e.open({animation:!0,templateUrl:"modal.html",controller:"modalOfflineCtrl"})}}]),lightcontroller.service("ShareOfflineGroup",function(){var t={name:""};return t}),lightcontroller.controller("modalOfflineCtrl",["$scope","$uibModalInstance","ShareOfflineGroup","$http","ShareZoomLight","$location",function(t,e,a,o,n,i){t.groupName=a,t.lightZ=n,t.light={},t.displayedCollection=[],t.rowCollection=[],t.displayedCollection=[].concat(t.rowCollection),t.ZoomLight=function(a,o){t.lightZ.lat=a,t.lightZ["long"]=o,t.lightZ.view=!0,i.path("#/dash"),pageInd("1"),e.dismiss()},t.itemsByPage=10,o({method:"GET",url:"/lights/getLights"}).then(function(e){for(var a=[],o=0;o<e.data.length;o++)e.data[o].group.grupo==t.groupName.name&&"0"==e.data[o].status.status&&("1"==e.data[o].status.status?e.data[o].status.status="OK":e.data[o].status.status="Alerta","0"==e.data[o].status.dimmer?e.data[o].status.dimmer="Desligada":e.data[o].status.dimmer=e.data[o].status.dimmer+"%",a.push(e.data[o]));t.rowCollection=a,console.log(t.rowCollection)},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.cancel=function(){e.dismiss()}}]),lightcontroller.controller("powerGraphCtrl",["$scope","$http","$timeout","$location","$window",function(t,e,a,o,n){var i=5e3;t.intervalFunction=function(){time=a(function(){t.getData(),t.intervalFunction()},i)},t.intervalFunction(),t.$on("$routeChangeStart",function(t,e,o){a.cancel(time)});var r;t.groupName="Total";var s=new Highcharts.Chart({chart:{type:"spline",renderTo:"powerGraph",animation:Highcharts.svg,marginRight:10,events:{load:function(){var t=this.series[0];setInterval(function(){var e=(new Date).getTime(),a=r;t.addPoint([e,a],!0,!0)},i)}}},title:{text:" "},xAxis:{type:"datetime",tickPixelInterval:150},yAxis:{title:{text:"Potência Instantânea"},plotLines:[{value:0,width:1,color:"#000000"}]},tooltip:{formatter:function(){return"<b>"+this.series.name+"-"+t.groupName+"</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/><b>"+Highcharts.numberFormat(this.y,2)+"W</b>"}},legend:{enabled:!1},plotOptions:{series:{color:"#000000"},line:{connectNulls:!0}},exporting:{enabled:!1},series:[{name:"Potência",data:function(){var t,e=[],a=(new Date).getTime();for(t=-19;0>=t;t+=1)e.push({x:a+1e3*t,y:0});return e}()}]});t.getData=function(){e({url:"/log/getPower",method:"POST",data:[t.groupName],headers:{"Content-Type":"application/json"}}).then(function(t){r=t.data[0].power.value?t.data[0].power.value:0},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.changeGraph=function(e){t.groupName=e},$(".toggled").on("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",function(){null!==document.getElementById("powerGraph")&&s.setSize($("#powerGraph").width(),$("#powerGraph").height())}),$(".untoggled").on("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",function(){null!==document.getElementById("powerGraph")&&s.setSize($("#powerGraph").width(),$("#powerGraph").height())})}]),lightcontroller.controller("alertCtrl",["$scope","$http","$timeout","$location","$window",function(t,e,a,o,n){e({method:"GET",url:"/cfg/defaultCfg"}).then(function(e){t.maxAlert=e.data[0].numberAlert},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.alerts=[],t.closeAlert=function(e){t.alerts.splice(e,1)},t.intervalFunction=function(){time=a(function(){e({method:"GET",url:"/groups/getGroups"}).then(function(e){t.groups=e.data;for(var a=0,o=0;o<t.groups.length;o++)a+=t.groups[o].offline;a>=t.maxAlert&&(t.alerts[0]={type:"danger",msg:"Luminárias em alerta!"})},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.intervalFunction()},2e3)},t.intervalFunction()}]),lightcontroller.controller("usersCtrl",["$scope","$http","$templateCache","$location","$window",function(t,e,a,o,n){function i(){e({method:"GET",url:"/users/getUsers"}).then(function(e){for(var a=0;a<e.data.length;a++)e.data[a].profile.admin?e.data[a].profile.admin="Sim":e.data[a].profile.admin="Não";t.rowCollection=e.data},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})}t.user={admin:!1},t.displayedCollection=[],t.rowCollection=[],t.displayedCollection=[].concat(t.rowCollection),t.addRow=function(){t.rowCollection.push({profile:{admin:"sim",username:"teste"}})},e({method:"GET",url:"/users/getUsers"}).then(function(e){for(var a=0;a<e.data.length;a++)e.data[a].profile.admin?e.data[a].profile.admin="Sim":e.data[a].profile.admin="Não";t.rowCollection=e.data},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.listUsers=function(a){e({method:"POST",url:"/users/getUsers"}).then(function(e){for(var a=0;a<e.data.length;a++)e.data[a].profile.admin?e.data[a].profile.admin="Sim":e.data[a].profile.admin="Não";t.rowCollection=e.data},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.removeUser=function(a){e({url:"/users/removeUsers",method:"POST",data:{username:a.profile.username},headers:{"Content-Type":"application/json"}}).then(function(t){"ok"==t.data.status?(console.log("Usuário removido com sucesso!"),i()):alert("Usuário não encontrado!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.adduser=function(){e({url:"/users/addUsers",method:"POST",data:t.user,headers:{"Content-Type":"application/json"}}).then(function(t){"ok"==t.data.status?(i(),alert("Usuário adicionado com sucesso!")):alert("Não foi possível adicionar o usuário informado, \n[Nome de usuário] já existe!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.changePass=function(){e({url:"/users/changePass",method:"POST",data:{username:n.loginUser,password:t.user.password},headers:{"Content-Type":"application/json"}}).then(function(t){"ok"==t.data.status?alert("Senha alterada com sucesso!"):alert("Não foi possível alterar a senha informada!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})}}]),lightcontroller.controller("csvCtrl",["$scope","$http","$parse","$templateCache",function(t,e,a,o){function n(t,e){var a;return a=-1!=e.search(t)?!0:!1}function i(t){for(var e=t,a=[],o=0;o<t.length-1;o++)e[o+1]==e[o]&&a.push(e[o]);return a}function r(){var e=t.csv.content,a=n("DeviceAddress",e),o=n("MAC",e),i=n("TAG",e),r=n("LAT",e),s=n("LONG",e),l=n("Grupo",e),u=n("Modelo",e),d=(n("Status",e),n("Nome",e));return a?o?i?r?s?l?u?d?"ok":(alert("Problema:Arquivo.csv não contém a tag [Nome]"),"bad"):(alert("Problema:Arquivo.csv não contém a tag [Modelo]"),"bad"):(alert("Problema:Arquivo.csv não contém a tag [Grupo]"),"bad"):(alert("Problema:Arquivo.csv não contém a tag [LONG]"),"bad"):(alert("Problema:Arquivo.csv não contém a tag [LAT]"),"bad"):(alert("Problema:Arquivo.csv não contém a tag [TAG]"),"bad"):(alert("Problema:Arquivo.csv não contém a tag [MAC]"),"bad"):(alert("Problema:Arquivo.csv não contém a tag [DeviceAddress]"),"bad")}function s(a){for(var o=0;o<a.length;o++)d.push({name:a[o].Nome,deviceAddress:a[o].DeviceAddress,MAC:a[o].MAC,TAG:a[o].TAG,LAT:a[o].LAT,LONG:a[o].LONG,group:{grupo:a[o].Grupo},status:{status:"0",dimmer:20,rssi:-50,current:100},model:a[o].Modelo});e({url:"/lights/save",method:"POST",data:d,headers:{"Content-Type":"application/json"}}).then(function(t){"ok"==t.data.status?alert("Luminárias salvas com sucesso no banco de dados!"):alert("Não foi possível adicionar o arquivo csv informado!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})}var l,u,d=[],c=[];t.csv={content:null,header:!0,separator:",",result:null,encoding:"ISO-8859-1",accept:".csv"},t.$watch("csv.result",function(){if(t.csv.result){l=t.csv.result;for(var e=[],a=0;a<l.length;a++)e.push(l[a].TAG);var o=i(e);o[0]?alert("Não foi possível carregar o arquivo de configurações, existem TAGs duplicadas:\n"+o):"ok"==r()&&s(l)}}),t.exportLights=function(){e({method:"GET",url:"/lights/getLights"}).then(function(e){u=e.data;for(var a=1;a<u.length;a++)c.push({DeviceAddress:u[a].deviceAddress,Nome:u[a].name,MAC:u[a].MAC,TAG:u[a].TAG,LAT:u[a].LAT,LONG:u[a].LONG,Grupo:u[a].group.grupo,Modelo:u[a].model});t.dataCSV=c},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})};for(var m=[],g=["-29.67423597","-29.68663011","-29.66839225","-29.69386197"],p=["-51.12000968","-51.09775882","-51.08316544","-51.1169544"],h=0;4>h;h++)m.push({DeviceAddress:"XXXXXX"+h,Nome:"Luminaria "+h,MAC:"XX-XX-XX-XX-XX-X"+h,TAG:"L000"+h,LAT:g[h],LONG:p[h],Grupo:"Grupo "+h,Modelo:"HDA-01"});t.demoCSV=m,t.restoreCfgs=function(){e({method:"GET",url:"/cfg/defaultCfg"}).then(function(e){e.data[0].voltagePlant||e.data[0].numberAlert?(t.voltagePlant=e.data[0].voltage,t.numberAlert=e.data[0].numberAlert,t.slackToken=e.data[0].slackToken,t.botSlack=e.data[0].botSlack,t.channelSlack=e.data[0].channelSlack,e.data[0].emailAlert&&(t.emailAlert=e.data[0].emailAlert),e.data[0].timeEmailAlert&&(t.timeEmailAlert=e.data[0].timeEmailAlert)):alert("[ATENÇÃO]Nenhum valor configurado para tensão e alertas!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.saveCfg=function(){var a={voltage:t.voltagePlant,numberAlert:t.numberAlert,emailAlert:t.emailAlert,timeEmailAlert:t.timeEmailAlert,slackToken:t.slackToken,channelSlack:t.channelSlack,botSlack:t.botSlack};t.emailAlert?!t.timeEmailAlert||t.timeEmailAlert<30?alert("[Atenção] Você inseriu um e-mail porém não um intervalo valido em segundos!"):e({url:"/cfg/save",method:"POST",data:a,headers:{"Content-Type":"application/json"}}).then(function(t){"ok"==t.data.status?alert("Configurações salvas com sucesso!"):alert("Não foi possível salvar as configurações!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}):alert("[Atenção] Você não inseriu um e-mail válido!")}}]),lightcontroller.service("SharelightTAGlist",function(){var t={tag:"",dimmer:"",lat:"","long":""};return t}),lightcontroller.controller("listCtrl",["$scope","SharelightTAGid","$uibModal","$http","$templateCache","ShareZoomLight","SharelightTAGlist","$location",function(t,e,a,o,n,i,r,s){t.light={},t.displayedCollection=[],t.rowCollection=[],t.displayedCollection=[].concat(t.rowCollection),t.itemsByPage=20,t.lightZ=i,t.ZoomLight=function(e,a){t.lightZ.lat=e,t.lightZ["long"]=a,t.lightZ.view=!0,s.path("#/dash"),pageInd("1")},o({method:"GET",url:"/lights/getLights"}).then(function(e){for(var a=0;a<e.data.length;a++)"1"==e.data[a].status.status?e.data[a].status.status="OK":e.data[a].status.status="Alerta","0"==e.data[a].status.dimmer?e.data[a].status.dimmer="Desligada":e.data[a].status.dimmer=e.data[a].status.dimmer+"%";t.rowCollection=e.data},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.lightSelDev=r,t.lightZ=i,t.lightSel=e,t.DimmerLight=function(e,o,n,i){t.lightSel.tag=e,t.lightSel.dimmer=o,t.lightSel.lat=n,t.lightSel["long"]=i;a.open({animation:!0,templateUrl:"modalLights.html",controller:"ModalInstanceCtrl"})},t.pageLight=function(e){t.lightSelDev.TAG=e;a.open({size:"lg",animation:!0,templateUrl:"modal.html",controller:"modalLightCtrl"})}}]),lightcontroller.controller("modalLightCtrl",["$scope","$timeout","$uibModalInstance","SharelightTAGlist","$http","$location",function(t,e,a,o,n,i){t.lightSelDev=o,n({method:"GET",url:"/lights/getLights"}).then(function(e){for(var a=0;a<e.data.length;a++)e.data[a].TAG==t.lightSelDev.TAG&&("1"==e.data[a].status.status?e.data[a].status.status="Ativa":e.data[a].status.status="Offline",t.lightSpec=e.data[a],t.toggle=!1)},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.cancel=function(){a.dismiss()}}]),lightcontroller.controller("timeCtrl",["$scope","$http","$timeout",function(t,e,a){function o(){e({method:"GET",url:"/alarms/getAlarms"}).then(function(e){t.rowCollection=e.data},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})}function n(t){for(var e=c.series,a=0;a<e.length;a++)if(t.group==e[a].name)for(var o=c.series[a].data,n=0;n<o.length;n++)o[n].x==r(t.time)&&o[n].y==Number(t.dimmer)&&c.series[a].data[n].remove()}function i(t){for(var e=c.series,a=0;a<e.length;a++)for(var o=0;o<t.length;o++)t[o].group==e[a].name&&c.series[a].addPoint([r(t[o].time),Number(t[o].dimmer)])}function r(t){var e=moment(t).format("HH:mm"),a=e.split(":"),o=60*Number(a[0])*60*1e3+60*Number(a[1])*1e3;return o}function s(t){for(var e=c.series,a=0;a<e.length;a++)t.group==e[a].name&&(console.log(t.time),c.series[a].addPoint([r(t.time),Number(t.dimmer)]))}function l(a){for(var o=0;o<a.values.length;o++)c.addSeries({name:a.values[o],step:"left",data:[[0,0],[864e5,0]]});e({method:"GET",url:"/alarms/getAlarms"}).then(function(t){i(t.data)},function(e){t.data=e.data||"Request failed",t.status=e.status})}t.settings={"default":function(){var t=new Date;return t}},t.hstep=1,t.mstep=1,t.ismeridian=!1,t.dimmer="20% - Mínimo",t.dimopt={values:["Desligar","20% - Mínimo","30%","40%","50%","60%","70%","80%","90%","100% - Máximo"]};var u={values:[]};e({method:"GET",url:"/groups/getGroups"}).then(function(e){t.groups=e.data[0].name;for(var a=0;a<e.data.length;a++)u.values.push(e.data[a].name);t.groupopt=u,l(t.groupopt)},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.displayedCollection=[],t.rowCollection=[],t.displayedCollection=[].concat(t.rowCollection),t.itemsByPage=20,e({method:"GET",url:"/alarms/getAlarms"}).then(function(e){t.rowCollection=e.data},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.createAlarm=function(a,n,i){"undefined"==typeof a&&(a=new Date),"Desligar"==i&&(i="0%");var r={timeAlarm:a,dimmer:i.split(" ")[0].split("%")[0],group:n},l={time:a,dimmer:i.split(" ")[0].split("%")[0],group:n};s(l),e({url:"/alarms/save",method:"POST",data:r,headers:{"Content-Type":"application/json"}}).then(function(e){"ok"==e.data.status?(alert("Alarme agendado com sucesso!"),o(),t.updatedGroup=r.groups):alert("Não foi possível agendar o alarme pois ele já existe!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.deleteAlarm=function(a){n(a),e({url:"/alarms/removeAlarms",method:"POST",data:{dimmer:a.dimmer,group:a.group,time:a.time},headers:{"Content-Type":"application/json"}}).then(function(a){"ok"==a.data.status?(e({method:"GET",url:"/alarms/getAlarms"}).then(function(e){t.rowCollection=e.data},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),console.log("Alarme removido com sucesso!")):alert("Alarme não encontrado!")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})};var d=function(){a(d,1e3),e({method:"GET",url:"/time/getServerTime"}).then(function(e){t.timeN=e.data.data},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})};d();var c=new Highcharts.Chart({chart:{type:"area",renderTo:"graphTime"},title:{text:"Horários"},subtitle:{text:"Diário"},credits:{enabled:!1},xAxis:{min:0,max:864e5,showFirstLabel:!0,tickInterval:72e5,type:"datetime",dateTimeLabelFormats:{hour:"%H:%M"},title:{text:"Time"},labels:{format:"{value:%H:%M}",enabled:!0},gridLineWidth:1,plotBands:[{from:0,to:216e5,color:"#f5f5f5",label:{text:"",style:{color:"#999999"}}},{from:216e5,to:648e5,color:"#ffffff",label:{text:"",style:{color:"#999999"}}},{from:648e5,to:864e5,color:"#f5f5f5",label:{text:"",style:{color:"#999999"}}}]},global:{useUTC:!1},yAxis:{title:{text:"Dimmer"},min:0,max:100,tickInterval:10,minTickInterval:10,labels:{format:"{value} %"}},tooltip:{headerFormat:"<b>{series.name}</b><br>",pointFormat:"{point.x:%H:%M} - {point.y} %",shared:!1,borderRadius:0,borderWidth:0,shadow:!0,enabled:!0,backgroundColor:"none"},plotOptions:{spline:{marker:{enabled:!0}},area:{fillOpacity:.1}}});$(".toggled").on("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",function(){null!==document.getElementById("graphTime")&&c.setSize($("#graphTime").width(),$("#graphTime").height())}),$(".untoggled").on("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",function(){null!==document.getElementById("graphTime")&&c.setSize($("#graphTime").width(),$("#graphTime").height())})}]),lightcontroller.controller("powerCtrl",["$scope","$http","$timeout","$TreeDnDConvert",function(t,e,a,o){t.intervalFunction=function(){time=a(function(){t.getData(),t.intervalFunction()},900)},t.$on("$routeChangeStart",function(t,e,o){a.cancel(time)});var n,i={values:[]};t.groupName="Total",e({method:"GET",url:"/groups/getGroups"}).then(function(e){t.groups=e.data[0].name;for(var a=0;a<e.data.length;a++)i.values.push(e.data[a].name);t.groupopt=i},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),Highcharts.setOptions({global:{useUTC:!1}});var r=new Highcharts.Chart({chart:{type:"spline",renderTo:"powerGraph",animation:Highcharts.svg,marginRight:10,events:{load:function(){var t=this.series[0];setInterval(function(){var e=(new Date).getTime(),a=n;t.addPoint([e,a],!0,!0)},1e3)}}},title:{text:" "},xAxis:{type:"datetime",tickPixelInterval:150},yAxis:{title:{text:"Potência Instantânea"},plotLines:[{value:0,width:1,color:"#000000"}]},tooltip:{formatter:function(){return"<b>"+this.series.name+"-"+t.groupName+"</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/><b>"+Highcharts.numberFormat(this.y,2)+"W</b>"}},legend:{enabled:!1},plotOptions:{series:{color:"#000000"},line:{connectNulls:!0}},exporting:{enabled:!1},series:[{name:"Potência",data:function(){var t,e=[],a=(new Date).getTime();for(t=-19;0>=t;t+=1)e.push({x:a+1e3*t,y:0});return e}()}]});t.getData=function(){e({url:"/log/getPower",method:"POST",data:[t.groupName],headers:{"Content-Type":"application/json"}}).then(function(t){n=t.data[0].power.value?t.data[0].power.value:0},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)})},t.changeGraph=function(e){t.groupName=e},$(".toggled").on("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",function(){null!==document.getElementById("powerGraph")&&r.setSize($("#powerGraph").width(),$("#powerGraph").height())}),$(".untoggled").on("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",function(){null!==document.getElementById("powerGraph")&&r.setSize($("#powerGraph").width(),$("#powerGraph").height())});var s;t.tree_data={},t.my_tree=s={},t.tree_data="load",e({method:"GET",url:"/groups/getGroupsList"}).then(function(e){t.tree_data=o.line2tree(e.data,"DemographicId","ParentId")},function(e){t.data=e.data||"Request failed",t.status=e.status,console.log(t.status)}),t.toggle=!0,t.showLoading=function(){time=a(function(){"load"==t.tree_data?console.log("Carregando..."):(a.cancel(time),console.log("Carregado!"),t.toggle=!1,$("#loading").fadeOut(),$("#mainPwrScr").fadeIn()),t.intervalFunction()},500)},t.showLoading(),t.expanding_property={field:"Grupo",titleClass:"text-left",cellClass:"v-middle",displayName:"Grupo"},t.col_defs=[{field:"Potência"},{field:"Status"}]}]),lightcontroller.config(["ChartJsProvider",function(t){t.setOptions({colours:["#464646","#FF8A80","blue"],responsive:!0}),t.setOptions("Line",{datasetFill:!0})}]);